<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CYCLUS: cyclus::Hdf5Back Class Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">CYCLUS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="annotated.html"><span>Class&#160;List</span></a></li>
      <li><a href="hierarchy.html"><span>Class&#160;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&#160;Members</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="namespacecyclus.html">cyclus</a>      </li>
      <li class="navelem"><a class="el" href="classcyclus_1_1Hdf5Back.html">Hdf5Back</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">cyclus::Hdf5Back Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<!-- doxytag: class="cyclus::Hdf5Back" --><!-- doxytag: inherits="cyclus::FullBackend" --><hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>An <a class="el" href="classcyclus_1_1Recorder.html" title="Collects and manages output data generation for the cyclus core and agents during a simulation...">Recorder</a> backend that writes data to an hdf5 file. </p>
<p>Identically named <a class="el" href="classcyclus_1_1Datum.html" title="Used to specify and send a collection of key-value pairs to the Recorder for recording.">Datum</a> objects have their data placed as rows in a single table.</p>
<p>The HDF5 backend ensures that every column in its tables is represented in the schema with a fixed size. This in turn ensures that the schema itself is of a fixed size. This fixed size constraint applies even to variable length (VL) data types (string, blob, vector, etc).</p>
<p>Variable length data is handled in a special way to ensure a fixed length column. The naive approach would be to set a maximum size based on the data available. However, this is not truly a fixed length data type. Instead, the HDF5 backend serves as an on-disk bidriectional hash map for each VL data type.</p>
<p>A regular hash table applies a hash function to keys and stores the values based on this hash. Keys are unique and values may be repeated for many keys. In a bidirectional hash map the keys and values are both one-to-one and onto. This makes storing a seperate hash redunant and since the key and hash are the same.</p>
<p>The HDF5 backend uses the well-known SHA1 hash function as its keys for VL data. This is because SHA1 is 5x the size (20 bytes) of standard 32-bit unsigned ints. This provides a gigantic address space in which to store variable length data. HDF5 provides two critical features that make an address space of this size possible: multidiemnsional arrays and chunking.</p>
<p>HDF5 easily supports 5D arrays. This allows us to use the SHA1 hash not only as a key, but also a we can cast it to an index (len-5 array of unsigned ints) for a 5D array. Furthermore, for such an array we can set the chunksize to a single element ([1, 1, 1, 1, 1]). This allows us to have the full space available ([UINT_MAX, UINT_MAX, UINT_MAX, UINT_MAX, UINT_MAX]) while only storing the data that actually exists!</p>
<p>In the table columns for VL data, the HDF5 backend stores the SHA1 as a length-5 array of unsigned ints. Looking up the associated value is simply a matter of using this array as an index into a special data type array as above. This has the added advantage of de-duplicating storage for identical entries.</p>
<p>On disk the keys and values for a data type are stored as arrays named with base data type and the string "Keys" and "Vals" appended respectively. For instance, BLOB is stored in the arrays BlobKeys and BlobVals while VL_VECTOR_INT is stored in the arrays VectorIntKeys and VectorIntVals.</p>
<p>In memory, all active keys are stored in vlkeys_ private member of this class. This maps the DbType to a set of the SHA1 digests. This is used to prevent excessive writing of values to disk that already exist.</p>
<p>The cost of the bidirectional hash map strategy is that the values need to be looked up in a separate read() from that of the table itself. However, by using VL data types users should expect a performance hit and this is one of the more effiecient strategies.</p>
<p>Another implicit problem with all hash mappings is the possibility of collision. However, this is in practice impossible here. For SHA1, there is a 3.4e-13 chance of having a single collission with 1e18 (a billion billion) entries.</p>
<p>Still, if the address space of SHA1 ever becomes insufficient for some reason, please move to a larger SHA value such as SHA224 or SHA256 or higher. Such a migration is not anticipated but would be straighforward. </p>

<p>Definition at line <a class="el" href="hdf5__back_8h_source.html#l00074">74</a> of file <a class="el" href="hdf5__back_8h_source.html">hdf5_back.h</a>.</p>
</div>
<p><code>#include &lt;<a class="el" href="hdf5__back_8h_source.html">hdf5_back.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for cyclus::Hdf5Back:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classcyclus_1_1Hdf5Back.png" usemap="#cyclus::Hdf5Back_map" alt=""/>
  <map id="cyclus::Hdf5Back_map" name="cyclus::Hdf5Back_map">
<area href="classcyclus_1_1FullBackend.html" title="Interface implemented by backends that support recording and querying." alt="cyclus::FullBackend" shape="rect" coords="87,56,251,80"/>
<area href="classcyclus_1_1QueryableBackend.html" title="Interface implemented by backends that support rudimentary querying." alt="cyclus::QueryableBackend" shape="rect" coords="0,0,164,24"/>
<area href="classcyclus_1_1RecBackend.html" title="An abstract base class for listeners (e.g." alt="cyclus::RecBackend" shape="rect" coords="174,0,338,24"/>
</map>
 </div></div>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#a5a83546c0e3900ed24f4d146c493206a">Flush</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#ae72a9c75f1e9097b6f4b3e83fbe0ca01">Hdf5Back</a> (std::string path)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#a938a819bc30c43205f592d77a97b2fca">Name</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#a9026bba3342dc7b85552d90a749bc626">Notify</a> (<a class="el" href="namespacecyclus.html#a4c4371715e72de7170722867b3bf111b">DatumList</a> data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual <a class="el" href="classcyclus_1_1QueryResult.html">QueryResult</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#ab3fbf70c81975fba750a82b2c7d4942a">Query</a> (std::string table, std::vector&lt; <a class="el" href="classcyclus_1_1Cond.html">Cond</a> &gt; *conds)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">virtual&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcyclus_1_1Hdf5Back.html#acddef4bd56085ffabc0a09c6a5c85e3c">~Hdf5Back</a> ()</td></tr>
</table>
<hr/><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="ae72a9c75f1e9097b6f4b3e83fbe0ca01"></a><!-- doxytag: member="cyclus::Hdf5Back::Hdf5Back" ref="ae72a9c75f1e9097b6f4b3e83fbe0ca01" args="(std::string path)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcyclus_1_1Hdf5Back.html#ae72a9c75f1e9097b6f4b3e83fbe0ca01">cyclus::Hdf5Back::Hdf5Back</a> </td>
          <td>(</td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>path</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Creates a new backend writing data to the specified file. </p>
<dl class="params"><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">path</td><td>the file to write to. If it exists, it will be overwritten. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="hdf5__back_8cc_source.html#l00010">10</a> of file <a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a>.</p>

</div>
</div>
<a class="anchor" id="acddef4bd56085ffabc0a09c6a5c85e3c"></a><!-- doxytag: member="cyclus::Hdf5Back::~Hdf5Back" ref="acddef4bd56085ffabc0a09c6a5c85e3c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcyclus_1_1Hdf5Back.html#acddef4bd56085ffabc0a09c6a5c85e3c">cyclus::Hdf5Back::~Hdf5Back</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>cleans up resources and closes the file. </p>

<p>Definition at line <a class="el" href="hdf5__back_8cc_source.html#l00040">40</a> of file <a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a>.</p>

</div>
</div>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a5a83546c0e3900ed24f4d146c493206a"></a><!-- doxytag: member="cyclus::Hdf5Back::Flush" ref="a5a83546c0e3900ed24f4d146c493206a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">virtual void <a class="el" href="classcyclus_1_1Hdf5Back.html#a5a83546c0e3900ed24f4d146c493206a">cyclus::Hdf5Back::Flush</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [inline, virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Flushes all buffered data in the backend to its final format/location. </p>

<p>Implements <a class="el" href="classcyclus_1_1RecBackend.html#a0975da69e43b0151c482db6fade9edec">cyclus::RecBackend</a>.</p>

<p>Definition at line <a class="el" href="hdf5__back_8h_source.html#l00088">88</a> of file <a class="el" href="hdf5__back_8h_source.html">hdf5_back.h</a>.</p>

</div>
</div>
<a class="anchor" id="a938a819bc30c43205f592d77a97b2fca"></a><!-- doxytag: member="cyclus::Hdf5Back::Name" ref="a938a819bc30c43205f592d77a97b2fca" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">std::string <a class="el" href="classcyclus_1_1Hdf5Back.html#a938a819bc30c43205f592d77a97b2fca">cyclus::Hdf5Back::Name</a> </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Used to uniquely identify a backend - particularly if there are more than one in a simulation. </p>

<p>Implements <a class="el" href="classcyclus_1_1RecBackend.html#a91f4153f4a574722d6778b46b0aff4a7">cyclus::RecBackend</a>.</p>

<p>Definition at line <a class="el" href="hdf5__back_8cc_source.html#l00972">972</a> of file <a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a>.</p>

</div>
</div>
<a class="anchor" id="a9026bba3342dc7b85552d90a749bc626"></a><!-- doxytag: member="cyclus::Hdf5Back::Notify" ref="a9026bba3342dc7b85552d90a749bc626" args="(DatumList data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void <a class="el" href="classcyclus_1_1Hdf5Back.html#a9026bba3342dc7b85552d90a749bc626">cyclus::Hdf5Back::Notify</a> </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="namespacecyclus.html#a4c4371715e72de7170722867b3bf111b">DatumList</a>&#160;</td>
          <td class="paramname"><em>data</em></td><td>)</td>
          <td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Used to pass a list of new/collected <a class="el" href="classcyclus_1_1Datum.html" title="Used to specify and send a collection of key-value pairs to the Recorder for recording.">Datum</a> objects. </p>

<p>Implements <a class="el" href="classcyclus_1_1RecBackend.html#adaff2ebbfe9fb8aaafe0fb91bb36537e">cyclus::RecBackend</a>.</p>

<p>Definition at line <a class="el" href="hdf5__back_8cc_source.html#l00065">65</a> of file <a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a>.</p>

</div>
</div>
<a class="anchor" id="ab3fbf70c81975fba750a82b2c7d4942a"></a><!-- doxytag: member="cyclus::Hdf5Back::Query" ref="ab3fbf70c81975fba750a82b2c7d4942a" args="(std::string table, std::vector&lt; Cond &gt; *conds)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcyclus_1_1QueryResult.html">QueryResult</a> <a class="el" href="classcyclus_1_1Hdf5Back.html#ab3fbf70c81975fba750a82b2c7d4942a">cyclus::Hdf5Back::Query</a> </td>
          <td>(</td>
          <td class="paramtype">std::string&#160;</td>
          <td class="paramname"><em>table</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">std::vector&lt; <a class="el" href="classcyclus_1_1Cond.html">Cond</a> &gt; *&#160;</td>
          <td class="paramname"><em>conds</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td><code> [virtual]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Return a set of rows from the specificed table that match all given conditions. </p>
<p>Conditions are AND'd together. conds may be NULL. </p>

<p>Implements <a class="el" href="classcyclus_1_1QueryableBackend.html#ad1284f9439a8179729cd1d155b9a7a25">cyclus::QueryableBackend</a>.</p>

<p>Definition at line <a class="el" href="hdf5__back_8cc_source.html#l00151">151</a> of file <a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a>.</p>

</div>
</div>

<p><a href="classcyclus_1_1Hdf5Back-members.html">List of all members.</a></p>
<hr/>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="hdf5__back_8h_source.html">hdf5_back.h</a></li>
<li><a class="el" href="hdf5__back_8cc_source.html">hdf5_back.cc</a></li>
</ul>
</div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Sep 30 2014 00:43:35 for CYCLUS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
